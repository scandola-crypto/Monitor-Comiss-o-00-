<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Vendas - Monitor Cont√°bil</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root{--bg:#003366;--accent:#ff6600;--muted:#001f4d;}
    body { font-family: Arial, sans-serif; background-color: var(--bg); color: #fff; margin: 16px; }
    h1 { color: var(--accent); display: flex; align-items: center; gap: 10px; flex-wrap:wrap; }
    h1 img { height: 40px; }
    .container { display: flex; flex-direction: column; gap: 16px; max-width:1200px; margin:0 auto; }
    .table-wrap{overflow-x:auto; border:1px solid rgba(255,102,0,0.15); border-radius:6px;}
    table { width: 100%; border-collapse: collapse; background: transparent; color: #fff; }
    th, td { border: 1px solid var(--accent); padding: 8px; text-align: center; }
    th { background-color: var(--accent); color: white; }
    button { padding: 6px 12px; background-color: var(--accent); color: var(--bg); border: none; cursor: pointer; margin: 4px; border-radius:4px; }
    button:hover { background-color: #fff; color: var(--bg); }
    input, select { padding: 6px; margin: 6px 4px; border-radius:4px; border:1px solid rgba(255,255,255,0.08); }
    .form-container { background: transparent; padding: 10px; border: 1px solid var(--accent); border-radius:6px; }
    .charts { display: flex; flex-direction: column; gap: 16px; align-items: center; }
    .chart-container { background: transparent; color: #fff; padding: 10px; border-radius: 5px; max-width: 600px; width: 100%; }
    .chart-container canvas{max-width:100% !important; max-height:400px !important;}
    .resumo-card{display:inline-block; margin:8px 12px 0 0; padding:8px 12px; background:rgba(255,255,255,0.05); border-left:3px solid var(--accent); border-radius:4px;}
    .resumo-card strong{color:var(--accent); font-size:18px;}
    .resumo-card small{color:#ccc; font-size:11px;}

    /* Mobile adjustments */
    @media (max-width: 700px){
        body{margin:10px}
        .form-container input, .form-container select{width:100%; box-sizing:border-box}
        h1 img{height:32px}
        th, td{font-size:13px}
        .resumo-card{display:block; margin:6px 0;}
    }
</style>
</head>
<body>
<h1><img src="https://media.licdn.com/dms/image/v2/C4D0BAQFl8jPoEN5H4A/company-logo_200_200/company-logo_200_200/0/1677181747889?e=2147483647&v=beta&t=7iLTTmqbkRp7wd4fVpxOn9PHdQxJ7Js2-sH6Zo0p2PA" alt="Logo Monitor Cont√°bil">Dashboard de Vendas - Monitor Cont√°bil</h1>
<div class="container">

    <div class="form-container">
        <h2>Adicionar / Editar Cliente</h2>
        <input type="hidden" id="clienteIndex">
        <input type="text" id="clienteNome" placeholder="Nome do Cliente" required>
        <input type="text" id="clienteCNPJ" placeholder="CNPJ" required>
        <input type="number" id="clienteMRR" placeholder="MRR" required>
        <input type="number" id="clienteSetup" placeholder="Implanta√ß√£o" required>
        
        <select id="clienteMes" required style="background:#fff; color:#333;">
            <option value="">üìÖ Selecione o M√™s *</option>
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Mar√ßo</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
        </select>
        
        <select id="clientePagamento" required>
            <option value="">Forma de Pagamento *</option>
            <option value="PIX">PIX</option>
            <option value="CART√ÉO">CART√ÉO</option>
            <option value="BOLETO">BOLETO</option>
        </select>
        
        <input type="text" id="clienteInfoPagamento" placeholder="Observa√ß√µes adicionais (opcional)">
        
        <button onclick="salvarCliente()">üíæ Salvar Cliente</button>
    </div>

    <div class="form-container" style="margin-top:10px;">
        <h3 style="color:#ff6600; margin:0 0 10px 0;">ÔøΩ Busca e Filtros</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <input type="text" id="campoBusca" placeholder="üîé Buscar por nome, CNPJ, pagamento..." 
                   oninput="aplicarFiltros()" style="flex:1; min-width:250px;">
            <select id="filtroMes" onchange="aplicarFiltros()" style="width:180px;">
                <option value="todos">üìÖ Todos os Meses</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Mar√ßo</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <button onclick="limparFiltros()" style="background:#666;">Limpar Filtros</button>
        </div>
        <div id="resultadoBusca" style="margin-top:8px; font-size:13px; color:#ffce56;"></div>
        <div id="resumoMes" style="margin-top:12px; padding:10px; background:rgba(255,102,0,0.1); border-radius:4px; display:none;">
            <strong style="color:#ff6600;">Resumo do M√™s:</strong><br>
            <span id="resumoTexto" style="font-size:14px;"></span>
        </div>
    </div>

    <div class="table-wrap">
    <table id="tabelaVendas">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>CNPJ</th>
                <th>M√™s</th>
                <th>MRR</th>
                <th>Implanta√ß√£o</th>
                <th>Pagamento</th>
                <th>Observa√ß√µes</th>
                <th>Comiss√£o %</th>
                <th>Valor Comiss√£o</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>

    <div class="charts">
        <div class="chart-container">
            <h3 style="color:#ff6600; margin:0 0 10px 0;" id="tituloGrafico">üìà Vis√£o Anual - Todos os Meses</h3>
            <canvas id="graficoValores" aria-label="Gr√°fico de pizza por m√™s" role="img"></canvas>
        </div>
    </div>

    <div style="margin-top: 10px;">
        <button onclick="baixarCSV()">Baixar CSV</button>
        <button id="limparBtn" onclick="limparDados()">Limpar dados</button>
    </div>
</div>

<script>
// URL do Google Apps Script (API do Google Sheets)
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhOzWuN6kIChZNkqGxwYuGTtMhWzz6jdhxkx2DiV7s_ycXSScElvAeDWOfBefb2p2F/exec';

// Inicia vazio - dados ser√£o carregados do Google Sheets
let clientes = [];

// Fun√ß√£o para carregar dados do Google Sheets
async function carregarDados() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL);
        const data = await response.json();
        clientes = data;
        atualizarTabela();
    } catch(e) {
        console.error('Erro ao carregar dados do Google Sheets:', e);
        alert('‚ö†Ô∏è Erro ao conectar com o Google Sheets. Verifique a conex√£o.');
    }
}

// Carregar dados ao iniciar
carregarDados();

function calcularComissao(valorTotal) {
    if(valorTotal <= 20000) return 20;
    else if(valorTotal <= 25000) return 25;
    else if(valorTotal <= 30000) return 30;
    else return 40;
}

let mesFiltroAtual = 'todos';
let buscaAtual = '';

function atualizarTabela() {
    // N√£o precisa mais salvar no localStorage - dados est√£o no Google Sheets

    const tbody = document.querySelector('#tabelaVendas tbody');
    tbody.innerHTML = '';
    
    // Aplicar filtros combinados: busca + m√™s
    let clientesFiltrados = clientes;

    // Filtro de busca
    if(buscaAtual.trim() !== '') {
        const termoBusca = buscaAtual.toLowerCase();
        clientesFiltrados = clientesFiltrados.filter(c => {
            return (c.Nome || '').toLowerCase().includes(termoBusca) ||
                   (c.CNPJ || '').toLowerCase().includes(termoBusca) ||
                   (c.Pagamento || '').toLowerCase().includes(termoBusca) ||
                   (c.InfoPagamento || '').toLowerCase().includes(termoBusca) ||
                   (c.MRR || '').toString().includes(termoBusca) ||
                   (c.Setup || '').toString().includes(termoBusca);
        });
    }

    // Filtro de m√™s
    if(mesFiltroAtual !== 'todos') {
        clientesFiltrados = clientesFiltrados.filter(c => {
            return c.Mes && parseInt(c.Mes) === parseInt(mesFiltroAtual);
        });
    }

    // Atualizar contador de resultados
    const resultadoDiv = document.getElementById('resultadoBusca');
    if(buscaAtual.trim() !== '' || mesFiltroAtual !== 'todos') {
        resultadoDiv.textContent = `üìã ${clientesFiltrados.length} registro(s) encontrado(s)`;
    } else {
        resultadoDiv.textContent = '';
    }

    const mesesNomes = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

    clientesFiltrados.forEach((c, index) => {
        // Encontrar o √≠ndice real no array original
        const indiceReal = clientes.indexOf(c);
        const valorTotal = parseFloat(c.MRR) + parseFloat(c.Setup);
        const comissaoPct = calcularComissao(valorTotal);
        const valorComissao = (valorTotal * comissaoPct / 100).toFixed(2);
        const mesNome = c.Mes ? mesesNomes[parseInt(c.Mes)] : '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${c.Nome}</td>
            <td>${c.CNPJ}</td>
            <td><strong style="color:#ffce56;">${mesNome}</strong></td>
            <td>${c.MRR}</td>
            <td>${c.Setup}</td>
            <td>${c.Pagamento}</td>
            <td>${c.InfoPagamento || '-'}</td>
            <td>${comissaoPct}%</td>
            <td>R$ ${valorComissao}</td>
            <td>
                <button onclick="editarCliente(${indiceReal})">Editar</button>
                <button onclick="excluirCliente(${indiceReal})">Excluir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    atualizarGraficos();
    atualizarResumoMes();
}

async function salvarCliente() {
    const index = document.getElementById('clienteIndex').value;
    const Nome = document.getElementById('clienteNome').value.trim();
    const CNPJ = document.getElementById('clienteCNPJ').value.trim();
    const MRR = document.getElementById('clienteMRR').value;
    const Setup = document.getElementById('clienteSetup').value;
    const Mes = document.getElementById('clienteMes').value;
    const Pagamento = document.getElementById('clientePagamento').value;
    const InfoPagamento = document.getElementById('clienteInfoPagamento').value.trim();

    if(!Nome || !CNPJ || !MRR || !Setup || !Mes || !Pagamento) {
        alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios (*)!');
        return;
    }

    const clienteData = {Nome, CNPJ, MRR, Setup, Mes, Pagamento, InfoPagamento};

    try {
        if(index === '') {
            // Adicionar novo cliente
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'add', ...clienteData})
            });
        } else {
            // Atualizar cliente existente
            const clienteAntigo = clientes[index];
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'update',
                    oldNome: clienteAntigo.Nome,
                    oldCNPJ: clienteAntigo.CNPJ,
                    ...clienteData
                })
            });
        }
        
        // Limpar formul√°rio
        document.getElementById('clienteIndex').value = '';
        document.getElementById('clienteNome').value = '';
        document.getElementById('clienteCNPJ').value = '';
        document.getElementById('clienteMRR').value = '';
        document.getElementById('clienteSetup').value = '';
        document.getElementById('clienteMes').value = '';
        document.getElementById('clientePagamento').value = '';
        document.getElementById('clienteInfoPagamento').value = '';
        
        // Recarregar dados
        setTimeout(() => carregarDados(), 1000);
        alert('‚úÖ Cliente salvo com sucesso!');
    } catch(e) {
        console.error('Erro ao salvar:', e);
        alert('‚ö†Ô∏è Erro ao salvar no Google Sheets.');
    }
}

function editarCliente(index) {
    const c = clientes[index];
    document.getElementById('clienteIndex').value = index;
    document.getElementById('clienteNome').value = c.Nome;
    document.getElementById('clienteCNPJ').value = c.CNPJ;
    document.getElementById('clienteMRR').value = c.MRR;
    document.getElementById('clienteSetup').value = c.Setup;
    document.getElementById('clienteMes').value = c.Mes || '';
    document.getElementById('clientePagamento').value = c.Pagamento;
    document.getElementById('clienteInfoPagamento').value = c.InfoPagamento || '';
    
    // Scroll para o topo do formul√°rio
    window.scrollTo({top: 0, behavior: 'smooth'});
}

async function excluirCliente(index) {
    if(!confirm('‚ö†Ô∏è Tem certeza que deseja excluir este cliente?')) return;
    
    const cliente = clientes[index];
    
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                action: 'delete',
                Nome: cliente.Nome,
                CNPJ: cliente.CNPJ
            })
        });
        
        setTimeout(() => carregarDados(), 1000);
        alert('‚úÖ Cliente exclu√≠do com sucesso!');
    } catch(e) {
        console.error('Erro ao excluir:', e);
        alert('‚ö†Ô∏è Erro ao excluir do Google Sheets.');
    }
}

let graficoValores;
function atualizarGraficos() {
    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const mesesCompletos = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    
    const ctxValores = document.getElementById('graficoValores').getContext('2d');
    if(graficoValores) graficoValores.destroy();

    // Se est√° filtrando por m√™s espec√≠fico, mostrar gr√°fico de barras detalhado
    if(mesFiltroAtual !== 'todos') {
        const mesNum = parseInt(mesFiltroAtual);
        const clientesMes = clientes.filter(c => {
            return c.Mes && parseInt(c.Mes) === mesNum;
        });

        const totalMRR = clientesMes.reduce((acc, c) => acc + (parseFloat(c.MRR) || 0), 0);
        const totalSetup = clientesMes.reduce((acc, c) => acc + (parseFloat(c.Setup) || 0), 0);
        const totalComissao = clientesMes.reduce((acc, c) => {
            const valorTotal = (parseFloat(c.MRR) || 0) + (parseFloat(c.Setup) || 0);
            return acc + (valorTotal * calcularComissao(valorTotal) / 100);
        }, 0);

        document.getElementById('tituloGrafico').textContent = `üìä Resumo de ${mesesCompletos[mesNum-1]}`;

        graficoValores = new Chart(ctxValores, {
            type: 'bar',
            data: {
                labels: ['MRR', 'Implanta√ß√£o', 'Comiss√£o'],
                datasets: [{
                    label: mesesCompletos[mesNum-1],
                    data: [totalMRR.toFixed(2), totalSetup.toFixed(2), totalComissao.toFixed(2)],
                    backgroundColor: ['#ff6384','#36a2eb','#ffce56'],
                    borderColor: '#0b2340',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#fff' } },
                    tooltip: { callbacks: { label: function(ctx){
                        return `R$ ${Number(ctx.parsed.y).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                    }}}
                },
                scales: {
                    x: { ticks: { color: '#fff' }, grid: { color: '#001f4d' } },
                    y: { ticks: { color: '#fff' }, grid: { color: '#001f4d' }, beginAtZero: true }
                }
            }
        });
    } else {
        // Vis√£o anual - gr√°fico de pizza com todos os meses
        const monthlyTotals = new Array(12).fill(0);

        clientes.forEach(c => {
            if(c.Mes) {
                const valor = (parseFloat(c.MRR) || 0) + (parseFloat(c.Setup) || 0);
                const monthIndex = Math.max(1, Math.min(12, parseInt(c.Mes))) - 1;
                monthlyTotals[monthIndex] += valor;
            }
        });

        document.getElementById('tituloGrafico').textContent = 'üìà Vis√£o Anual - Todos os Meses';

        const colors = ['#ff6384','#36a2eb','#ffce56','#66bb6a','#ab47bc','#ff7043','#29b6f6','#ffee58','#8d6e63','#9ccc65','#26a69a','#5c6bc0'];

        graficoValores = new Chart(ctxValores, {
            type: 'pie',
            data: {
                labels: meses,
                datasets: [{
                    data: monthlyTotals.map(v => +v.toFixed(2)),
                    backgroundColor: colors,
                    borderColor: '#0b2340',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#fff' }, position: 'bottom' },
                    tooltip: { callbacks: { label: function(ctx){
                        const val = ctx.parsed || 0; return `${ctx.label}: R$ ${Number(val).toLocaleString('pt-BR')}`;
                    }}}
                }
            }
        });
    }
}

async function limparDados(){
    if(!confirm('‚ö†Ô∏è Tem certeza que deseja limpar TODOS os dados do Google Sheets? Essa a√ß√£o n√£o pode ser desfeita!')) return;
    
    try {
        await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'clear'})
        });
        
        setTimeout(() => carregarDados(), 1000);
        limparFiltros();
        alert('‚úÖ Dados limpos com sucesso!');
    } catch(e) {
        console.error('Erro ao limpar dados:', e);
        alert('‚ö†Ô∏è Erro ao limpar dados do Google Sheets.');
    }
}

function aplicarFiltros() {
    mesFiltroAtual = document.getElementById('filtroMes').value;
    buscaAtual = document.getElementById('campoBusca').value;
    atualizarTabela();
}

function limparFiltros() {
    mesFiltroAtual = 'todos';
    buscaAtual = '';
    document.getElementById('filtroMes').value = 'todos';
    document.getElementById('campoBusca').value = '';
    atualizarTabela();
}

function atualizarResumoMes() {
    const resumoDiv = document.getElementById('resumoMes');
    const resumoTexto = document.getElementById('resumoTexto');
    
    if(mesFiltroAtual === 'todos') {
        resumoDiv.style.display = 'none';
        return;
    }

    const mesesCompletos = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const mesNum = parseInt(mesFiltroAtual);
    
    const clientesMes = clientes.filter(c => {
        return c.Mes && parseInt(c.Mes) === mesNum;
    });

    if(clientesMes.length === 0) {
        resumoDiv.style.display = 'block';
        resumoTexto.innerHTML = `<span style="color:#ffce56;">Nenhum registro encontrado para ${mesesCompletos[mesNum-1]}</span>`;
        return;
    }

    const totalMRR = clientesMes.reduce((acc, c) => acc + (parseFloat(c.MRR) || 0), 0);
    const totalSetup = clientesMes.reduce((acc, c) => acc + (parseFloat(c.Setup) || 0), 0);
    const totalGeral = totalMRR + totalSetup;
    const totalComissao = clientesMes.reduce((acc, c) => {
        const valorTotal = (parseFloat(c.MRR) || 0) + (parseFloat(c.Setup) || 0);
        return acc + (valorTotal * calcularComissao(valorTotal) / 100);
    }, 0);

    resumoDiv.style.display = 'block';
    resumoTexto.innerHTML = `
        <div class="resumo-card">
            <small>Clientes</small><br>
            <strong>${clientesMes.length}</strong>
        </div>
        <div class="resumo-card">
            <small>MRR Total</small><br>
            <strong>R$ ${totalMRR.toLocaleString('pt-BR', {minimumFractionDigits:2})}</strong>
        </div>
        <div class="resumo-card">
            <small>Implanta√ß√£o Total</small><br>
            <strong>R$ ${totalSetup.toLocaleString('pt-BR', {minimumFractionDigits:2})}</strong>
        </div>
        <div class="resumo-card">
            <small>Valor Total</small><br>
            <strong>R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits:2})}</strong>
        </div>
        <div class="resumo-card">
            <small>Comiss√£o Total</small><br>
            <strong style="color:#00ff88;">R$ ${totalComissao.toLocaleString('pt-BR', {minimumFractionDigits:2})}</strong>
        </div>
    `;
}

function baixarCSV() {
    if(clientes.length === 0) {
        alert('N√£o h√° dados para baixar!');
        return;
    }

    const mesesCompletos = ['','Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    const cabecalho = ['Nome','CNPJ','M√™s','MRR','Implanta√ß√£o','Pagamento','Observa√ß√µes','Comiss√£o %','Valor Comiss√£o'];
    const linhas = clientes.map(c => {
        const valorTotal = parseFloat(c.MRR) + parseFloat(c.Setup);
        const comissaoPct = calcularComissao(valorTotal);
        const valorComissao = (valorTotal * comissaoPct / 100).toFixed(2);
        const mesNome = c.Mes ? mesesCompletos[parseInt(c.Mes)] : '-';
        return [c.Nome, c.CNPJ, mesNome, c.MRR, c.Setup, c.Pagamento, c.InfoPagamento || '-', comissaoPct + '%', valorComissao].join(';');
    });

    const csvContent = [cabecalho.join(';'), ...linhas].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'vendas_monitor_contabil.csv');
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// N√£o chama mais atualizarTabela() aqui - ser√° chamado pelo carregarDados()
</script>
</body>
</html>