<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Vendas - Monitor Cont√°bil</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Font Awesome para √≠cones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --bg: #0a1628;
        --bg-secondary: #132540;
        --accent: #ff6600;
        --accent-hover: #ff8533;
        --success: #00ff88;
        --text-primary: #ffffff;
        --text-secondary: #a8b2c1;
        --border: rgba(255, 102, 0, 0.2);
        --card-bg: rgba(19, 37, 64, 0.6);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0a1628 0%, #1a2f4d 100%);
        color: var(--text-primary);
        padding: 20px;
        min-height: 100vh;
    }
    
    .header {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .header img { height: 50px; border-radius: 8px; }
    .header h1 { color: var(--accent); font-size: 26px; font-weight: 600; }
    
    .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--card-bg);
        padding: 30px 50px;
        border-radius: 12px;
        border: 2px solid var(--accent);
        z-index: 1000;
        text-align: center;
    }
    
    .loading.show { display: block; }
    
    .spinner {
        border: 3px solid var(--border);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    
    .card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .card h2 {
        color: var(--accent);
        font-size: 20px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .form-group label {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    input, select, textarea {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
    }
    
    .btn {
        padding: 12px 24px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn:hover {
        background: var(--accent-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 102, 0, 0.4);
    }
    
    .btn-secondary {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
        background: var(--border);
        transform: translateY(-2px);
    }
    
    .btn-danger {
        background: #dc3545;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    
    .btn-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--card-bg) 100%);
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid var(--accent);
        transition: transform 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
    }
    
    .stat-card .label {
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    
    .stat-card .value {
        color: var(--accent);
        font-size: 28px;
        font-weight: 700;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 10px;
        border: 1px solid var(--border);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        background: var(--bg-secondary);
    }
    
    th, td {
        padding: 14px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }
    
    th {
        background: var(--accent);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    td {
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    tbody tr {
        transition: background 0.3s;
    }
    
    tbody tr:hover {
        background: rgba(255, 102, 0, 0.05);
    }
    
    .mes-badge {
        display: inline-block;
        padding: 4px 12px;
        background: var(--accent);
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }
    
    .search-container {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .search-container input,
    .search-container select {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-info {
        background: rgba(255, 206, 86, 0.1);
        border-left: 3px solid #ffce56;
        padding: 12px 16px;
        border-radius: 6px;
        color: #ffce56;
        font-size: 14px;
        margin-top: 10px;
    }
    
    .chart-wrapper {
        background: var(--bg-secondary);
        padding: 20px;
        border-radius: 10px;
        margin-top: 16px;
    }
    
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: var(--success);
        color: #000;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        display: none;
        animation: slideIn 0.3s ease-out;
    }
    
    .toast.show { display: block; }
    .toast.error { background: #dc3545; color: white; }
    
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Pagina√ß√£o */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .pagination button {
        padding: 8px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
    }
    
    .pagination button:hover:not(:disabled) {
        background: var(--accent);
        border-color: var(--accent);
    }
    
    .pagination button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .pagination button.active {
        background: var(--accent);
        border-color: var(--accent);
        font-weight: 600;
    }
    
    .pagination-info {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 0 10px;
    }
    
    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal.show { display: flex; align-items: center; justify-content: center; }
    
    .modal-content {
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        border-radius: 16px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideDown 0.3s;
        border: 1px solid var(--border);
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--bg-secondary);
        border-radius: 16px 16px 0 0;
    }
    
    .modal-header i {
        font-size: 24px;
        color: var(--accent);
    }
    
    .modal-header h3 {
        margin: 0;
        color: var(--text-primary);
        font-size: 20px;
    }
    
    .modal-body {
        padding: 24px;
        color: var(--text-secondary);
        font-size: 16px;
        line-height: 1.6;
    }
    
    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: var(--bg-secondary);
        border-radius: 0 0 16px 16px;
    }
    
    .modal-footer .btn {
        min-width: 100px;
    }
    
    @media (max-width: 768px) {
        .header { flex-direction: column; text-align: center; }
        .header h1 { font-size: 20px; }
        .form-grid { grid-template-columns: 1fr; }
        .stats-grid { grid-template-columns: 1fr; }
        table { font-size: 12px; }
        th, td { padding: 8px; }
        .btn-group { flex-direction: column; }
        .btn { width: 100%; justify-content: center; }
        .modal-content { width: 95%; }
        .modal-footer { flex-direction: column; }
        .modal-footer .btn { width: 100%; }
    }
</style>
</head>
<body>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Carregando dados...</div>
</div>

<div class="toast" id="toast"></div>

<div class="header">
    <img src="https://media.licdn.com/dms/image/v2/C4D0BAQFl8jPoEN5H4A/company-logo_200_200/company-logo_200_200/0/1677181747889?e=2147483647&v=beta&t=7iLTTmqbkRp7wd4fVpxOn9PHdQxJ7Js2-sH6Zo0p2PA" alt="Logo">
    <h1><i class="fas fa-chart-line"></i> Dashboard de Vendas - Monitor Cont√°bil</h1>
</div>

<div class="container">
    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- Formul√°rio -->
    <div class="card">
        <h2><i class="fas fa-edit"></i> <span id="formTitle">Adicionar Cliente</span></h2>
        <form id="clienteForm" onsubmit="salvarCliente(event)">
            <input type="hidden" id="clienteIndex">
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="clienteNome">Nome do Cliente *</label>
                    <input type="text" id="clienteNome" placeholder="Ex: Empresa ABC Ltda" required>
                </div>
                
                <div class="form-group">
                    <label for="clienteCNPJ">CNPJ *</label>
                    <input type="text" id="clienteCNPJ" placeholder="00.000.000/0000-00" required>
                </div>
                
                <div class="form-group">
                    <label for="clienteMRR">MRR (R$) *</label>
                    <input type="number" id="clienteMRR" placeholder="0.00" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="clienteSetup">Implanta√ß√£o (R$) *</label>
                    <input type="number" id="clienteSetup" placeholder="0.00" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="clienteMes">M√™s *</label>
                    <select id="clienteMes" required>
                        <option value="">Selecione o m√™s</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="clientePagamento">Forma de Pagamento *</label>
                    <select id="clientePagamento" required>
                        <option value="">Selecione</option>
                        <option value="PIX">PIX</option>
                        <option value="CART√ÉO">CART√ÉO</option>
                        <option value="BOLETO">BOLETO</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
                <label for="clienteInfoPagamento">Observa√ß√µes (opcional)</label>
                <textarea id="clienteInfoPagamento" rows="2" placeholder="Informa√ß√µes adicionais..."></textarea>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button type="submit" class="btn"><i class="fas fa-save"></i> Salvar Cliente</button>
                <button type="button" class="btn btn-secondary" onclick="cancelarEdicao()"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Filtros -->
    <div class="card">
        <h2><i class="fas fa-filter"></i> Buscar e Filtrar</h2>
        <div class="search-container">
            <input type="text" id="campoBusca" placeholder="Buscar por nome, CNPJ, pagamento..." oninput="aplicarFiltros()">
            <select id="filtroMes" onchange="aplicarFiltros()">
                <option value="todos">Todos os Meses</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Mar√ßo</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <button class="btn btn-secondary" onclick="limparFiltros()"><i class="fas fa-eraser"></i> Limpar</button>
        </div>
        <div id="resultadoBusca"></div>
    </div>

    <!-- Tabela -->
    <div class="card">
        <h2><i class="fas fa-users"></i> Clientes Cadastrados</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>CNPJ</th>
                        <th>M√™s</th>
                        <th>MRR</th>
                        <th>Setup</th>
                        <th>Total</th>
                        <th>Pagamento</th>
                        <th>Observa√ß√µes</th>
                        <th>Comiss√£o %</th>
                        <th>Comiss√£o R$</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaBody"></tbody>
            </table>
        </div>
        
        <!-- Pagina√ß√£o -->
        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Gr√°ficos -->
    <div class="card">
        <h2 id="tituloGrafico"><i class="fas fa-chart-pie"></i> Vis√£o Anual</h2>
        <div class="chart-wrapper">
            <canvas id="graficoValores"></canvas>
        </div>
    </div>

    <!-- A√ß√µes -->
    <div class="card">
        <h2><i class="fas fa-tools"></i> A√ß√µes</h2>
        <div class="btn-group">
            <button class="btn" onclick="baixarCSV()"><i class="fas fa-download"></i> Baixar CSV</button>
            <button class="btn btn-secondary" onclick="recarregarDados()"><i class="fas fa-sync-alt"></i> Recarregar</button>
            <button class="btn btn-danger" onclick="limparDados()"><i class="fas fa-trash"></i> Limpar Tudo</button>
        </div>
    </div>
</div>

<script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzW4BW79bXogd6kL4C54syCeMTvjQPImJaWZlxOe-Cu3JrAos4CN5Pw5KJVPYn95B4W3g/exec';

let clientes = [];
let clientesFiltrados = [];
let mesFiltroAtual = 'todos';
let buscaAtual = '';
let graficoValores;

// Pagina√ß√£o
let paginaAtual = 1;
const registrosPorPagina = 5;

const mesesNomes = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
const mesesCompletos = ['', 'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    carregarDados();
});

// Fun√ß√µes de UI
function showLoading() {
    document.getElementById('loading').classList.add('show');
}

function hideLoading() {
    document.getElementById('loading').classList.remove('show');
}

function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    const icon = isError ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>';
    toast.innerHTML = `${icon} ${message}`;
    toast.className = 'toast show' + (isError ? ' error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// Carregar dados
async function carregarDados() {
    showLoading();
    try {
        console.log('üîÑ Carregando dados...');
        const response = await fetch(GOOGLE_SCRIPT_URL);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        clientes = Array.isArray(data) ? data : [];
        console.log('‚úÖ Dados carregados:', clientes.length, 'clientes');
        
        aplicarFiltros();
        atualizarStats();
        atualizarGraficos();
    } catch (error) {
        console.error('‚ùå Erro:', error);
        showToast('Erro ao carregar dados: ' + error.message, true);
        clientes = [];
        atualizarTabela();
    } finally {
        hideLoading();
    }
}

function recarregarDados() {
    carregarDados();
    showToast('Dados recarregados!');
}

// Calcular comiss√£o - Apenas 20% da Implanta√ß√£o (Setup)
function calcularComissao(valorSetup) {
    return 20; // Comiss√£o fixa de 20% sobre o valor da implanta√ß√£o
}

// Stats
function atualizarStats() {
    const totalClientes = clientes.length;
    const totalMRR = clientes.reduce((acc, c) => acc + parseFloat(c.MRR || 0), 0);
    const totalSetup = clientes.reduce((acc, c) => acc + parseFloat(c.Setup || 0), 0);
    const totalGeral = totalMRR + totalSetup;
    const totalComissao = clientes.reduce((acc, c) => {
        const setup = parseFloat(c.Setup || 0);
        return acc + (setup * calcularComissao(setup) / 100);
    }, 0);

    const statsGrid = document.getElementById('statsGrid');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="label"><i class="fas fa-users"></i> Total Clientes</div>
            <div class="value">${totalClientes}</div>
        </div>
        <div class="stat-card">
            <div class="label"><i class="fas fa-calendar-alt"></i> MRR Total</div>
            <div class="value">R$ ${totalMRR.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        </div>
        <div class="stat-card">
            <div class="label"><i class="fas fa-rocket"></i> Setup Total</div>
            <div class="value">R$ ${totalSetup.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        </div>
        <div class="stat-card">
            <div class="label"><i class="fas fa-coins"></i> Total Geral</div>
            <div class="value">R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        </div>
        <div class="stat-card">
            <div class="label"><i class="fas fa-hand-holding-usd"></i> Comiss√£o Total</div>
            <div class="value" style="color: var(--success)">R$ ${totalComissao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
        </div>
    `;
}

// Filtros
function aplicarFiltros() {
    mesFiltroAtual = document.getElementById('filtroMes').value;
    buscaAtual = document.getElementById('campoBusca').value.toLowerCase();
    
    clientesFiltrados = clientes.filter(c => {
        const matchBusca = !buscaAtual || 
            (c.Nome || '').toLowerCase().includes(buscaAtual) ||
            (c.CNPJ || '').toLowerCase().includes(buscaAtual) ||
            (c.Pagamento || '').toLowerCase().includes(buscaAtual) ||
            (c.InfoPagamento || '').toLowerCase().includes(buscaAtual);
        
        const matchMes = mesFiltroAtual === 'todos' || 
            parseInt(c.Mes) === parseInt(mesFiltroAtual);
        
        return matchBusca && matchMes;
    });
    
    const resultadoDiv = document.getElementById('resultadoBusca');
    if (buscaAtual || mesFiltroAtual !== 'todos') {
        resultadoDiv.innerHTML = `<div class="filter-info"><i class="fas fa-info-circle"></i> ${clientesFiltrados.length} registro(s) encontrado(s)</div>`;
    } else {
        resultadoDiv.innerHTML = '';
    }
    
    paginaAtual = 1;
    atualizarTabela();
    atualizarPaginacao();
    atualizarGraficos();
}

function limparFiltros() {
    document.getElementById('filtroMes').value = 'todos';
    document.getElementById('campoBusca').value = '';
    aplicarFiltros();
}

// Pagina√ß√£o
function atualizarPaginacao() {
    const paginationDiv = document.getElementById('pagination');
    const totalPaginas = Math.ceil(clientesFiltrados.length / registrosPorPagina);
    
    if (totalPaginas <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let html = '<button class="page-btn" onclick="mudarPagina(paginaAtual - 1)" ' + 
               (paginaAtual === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i> Anterior</button>';
    
    for (let i = 1; i <= totalPaginas; i++) {
        if (i === 1 || i === totalPaginas || (i >= paginaAtual - 1 && i <= paginaAtual + 1)) {
            html += `<button class="page-btn ${i === paginaAtual ? 'active' : ''}" onclick="mudarPagina(${i})">${i}</button>`;
        } else if (i === paginaAtual - 2 || i === paginaAtual + 2) {
            html += '<span class="page-ellipsis">...</span>';
        }
    }
    
    html += '<button class="page-btn" onclick="mudarPagina(paginaAtual + 1)" ' + 
            (paginaAtual === totalPaginas ? 'disabled' : '') + '>Pr√≥ximo <i class="fas fa-chevron-right"></i></button>';
    html += `<span class="page-info">P√°gina ${paginaAtual} de ${totalPaginas}</span>`;
    
    paginationDiv.innerHTML = html;
}

function mudarPagina(novaPagina) {
    const totalPaginas = Math.ceil(clientesFiltrados.length / registrosPorPagina);
    if (novaPagina < 1 || novaPagina > totalPaginas) return;
    
    paginaAtual = novaPagina;
    atualizarTabela();
    atualizarPaginacao();
    
    // Scroll suave para o topo da tabela
    document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Tabela
function atualizarTabela() {
    const tbody = document.getElementById('tabelaBody');
    
    if (clientesFiltrados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 16px;"><i class="fas fa-inbox"></i></div>
                    <div>Nenhum cliente cadastrado</div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Pagina√ß√£o
    const inicio = (paginaAtual - 1) * registrosPorPagina;
    const fim = inicio + registrosPorPagina;
    const clientesPagina = clientesFiltrados.slice(inicio, fim);
    
    tbody.innerHTML = clientesPagina.map((c, idx) => {
        const indiceReal = clientes.indexOf(c);
        const mrr = parseFloat(c.MRR || 0);
        const setup = parseFloat(c.Setup || 0);
        const total = mrr + setup;
        const comissaoPct = calcularComissao(setup); // Comiss√£o apenas sobre Setup
        const comissaoValor = (setup * comissaoPct / 100); // Calcula sobre Setup apenas
        const mesNome = c.Mes ? mesesNomes[parseInt(c.Mes)] : '-';
        
        return `
            <tr>
                <td style="color: var(--text-primary); font-weight: 500;">${c.Nome || 'Sem nome'}</td>
                <td>${c.CNPJ || '-'}</td>
                <td><span class="mes-badge">${mesNome}</span></td>
                <td>R$ ${mrr.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>R$ ${setup.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td style="color: var(--text-primary); font-weight: 600;">R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>${c.Pagamento || '-'}</td>
                <td>${c.InfoPagamento || '-'}</td>
                <td>${comissaoPct}%</td>
                <td style="color: var(--success); font-weight: 600;">R$ ${comissaoValor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>
                    <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 12px;" onclick="editarCliente(${indiceReal})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="excluirCliente(${indiceReal})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    }).join('');
}

// Gr√°ficos
function atualizarGraficos() {
    const ctx = document.getElementById('graficoValores').getContext('2d');
    if (graficoValores) graficoValores.destroy();
    
    if (mesFiltroAtual !== 'todos') {
        // Gr√°fico de barras para m√™s espec√≠fico
        const mesNum = parseInt(mesFiltroAtual);
        const clientesMes = clientes.filter(c => parseInt(c.Mes) === mesNum);
        
        const totalMRR = clientesMes.reduce((acc, c) => acc + parseFloat(c.MRR || 0), 0);
        const totalSetup = clientesMes.reduce((acc, c) => acc + parseFloat(c.Setup || 0), 0);
        const totalComissao = clientesMes.reduce((acc, c) => {
            const setup = parseFloat(c.Setup || 0);
            return acc + (setup * calcularComissao(setup) / 100);
        }, 0);
        
        document.getElementById('tituloGrafico').textContent = `üìä Resumo de ${mesesCompletos[mesNum]}`;
        
        graficoValores = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['MRR', 'Implanta√ß√£o', 'Comiss√£o'],
                datasets: [{
                    label: mesesCompletos[mesNum],
                    data: [totalMRR, totalSetup, totalComissao],
                    backgroundColor: ['#ff6384', '#36a2eb', '#ffce56'],
                    borderColor: '#0a1628',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#fff' } },
                    tooltip: {
                        callbacks: {
                            label: ctx => `R$ ${ctx.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#a8b2c1' },
                        grid: { color: 'rgba(255, 102, 0, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#a8b2c1' },
                        grid: { color: 'rgba(255, 102, 0, 0.1)' }
                    }
                }
            }
        });
    } else {
        // Gr√°fico de pizza anual
        const monthlyTotals = new Array(12).fill(0);
        clientes.forEach(c => {
            if (c.Mes) {
                const idx = parseInt(c.Mes) - 1;
                const valor = parseFloat(c.MRR || 0) + parseFloat(c.Setup || 0);
                monthlyTotals[idx] += valor;
            }
        });
        
        document.getElementById('tituloGrafico').textContent = 'üìà Vis√£o Anual - Todos os Meses';
        
        const colors = ['#ff6384', '#36a2eb', '#ffce56', '#66bb6a', '#ab47bc', '#ff7043', '#29b6f6', '#ffee58', '#8d6e63', '#9ccc65', '#26a69a', '#5c6bc0'];
        
        graficoValores = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: mesesNomes.slice(1),
                datasets: [{
                    data: monthlyTotals,
                    backgroundColor: colors,
                    borderColor: '#0a1628',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        labels: { color: '#fff' },
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: R$ ${ctx.parsed.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
                        }
                    }
                }
            }
        });
    }
}

// Salvar cliente
async function salvarCliente(event) {
    event.preventDefault();
    
    const index = document.getElementById('clienteIndex').value;
    const clienteData = {
        Nome: document.getElementById('clienteNome').value.trim(),
        CNPJ: document.getElementById('clienteCNPJ').value.trim(),
        MRR: document.getElementById('clienteMRR').value,
        Setup: document.getElementById('clienteSetup').value,
        Mes: document.getElementById('clienteMes').value,
        Pagamento: document.getElementById('clientePagamento').value,
        InfoPagamento: document.getElementById('clienteInfoPagamento').value.trim()
    };
    
    showLoading();
    try {
        if (index === '') {
            // Adicionar
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'add', ...clienteData })
            });
            showToast('‚úÖ Cliente adicionado com sucesso!');
        } else {
            // Atualizar
            const clienteAntigo = clientes[index];
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'update',
                    oldNome: clienteAntigo.Nome,
                    oldCNPJ: clienteAntigo.CNPJ,
                    ...clienteData
                })
            });
            showToast('‚úÖ Cliente atualizado com sucesso!');
        }
        
        cancelarEdicao();
        setTimeout(() => carregarDados(), 1500);
    } catch (error) {
        console.error('Erro:', error);
        showToast('‚ùå Erro ao salvar cliente', true);
    } finally {
        hideLoading();
    }
}

function editarCliente(index) {
    const c = clientes[index];
    document.getElementById('clienteIndex').value = index;
    document.getElementById('clienteNome').value = c.Nome;
    document.getElementById('clienteCNPJ').value = c.CNPJ;
    document.getElementById('clienteMRR').value = c.MRR;
    document.getElementById('clienteSetup').value = c.Setup;
    document.getElementById('clienteMes').value = c.Mes || '';
    document.getElementById('clientePagamento').value = c.Pagamento;
    document.getElementById('clienteInfoPagamento').value = c.InfoPagamento || '';
    document.getElementById('formTitle').textContent = 'Editar Cliente';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelarEdicao() {
    document.getElementById('clienteForm').reset();
    document.getElementById('clienteIndex').value = '';
    document.getElementById('formTitle').textContent = 'Adicionar Cliente';
}

async function excluirCliente(index) {
    const cliente = clientes[index];
    
    showModal(
        'Excluir Cliente',
        `Tem certeza que deseja excluir o cliente "${cliente.Nome}"? Esta a√ß√£o n√£o pode ser desfeita.`,
        async () => {
            showLoading();
            
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        Nome: cliente.Nome,
                        CNPJ: cliente.CNPJ
                    })
                });
                
                showToast('Cliente exclu√≠do com sucesso!');
                setTimeout(() => carregarDados(), 1500);
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao excluir cliente', true);
            } finally {
                hideLoading();
            }
        }
    );
}

async function limparDados() {
    showModal(
        '‚ö†Ô∏è ATEN√á√ÉO - APAGAR TODOS OS DADOS',
        'Esta a√ß√£o ir√° APAGAR PERMANENTEMENTE todos os dados do sistema. Esta opera√ß√£o N√ÉO PODE ser desfeita! Tem certeza absoluta que deseja continuar?',
        async () => {
            showLoading();
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'clear' })
                });
                
                showToast('Dados limpos com sucesso!');
                limparFiltros();
                setTimeout(() => carregarDados(), 1500);
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao limpar dados', true);
            } finally {
                hideLoading();
            }
        }
    );
}

function baixarCSV() {
    if (clientes.length === 0) {
        showToast('N√£o h√° dados para baixar!', true);
        return;
    }
    
    const cabecalho = ['Nome', 'CNPJ', 'M√™s', 'MRR', 'Setup', 'Total', 'Pagamento', 'Observa√ß√µes', 'Comiss√£o %', 'Valor Comiss√£o'];
    const linhas = clientes.map(c => {
        const mrr = parseFloat(c.MRR || 0);
        const setup = parseFloat(c.Setup || 0);
        const total = mrr + setup;
        const comissaoPct = calcularComissao(setup); // Comiss√£o apenas sobre Setup
        const comissaoValor = (setup * comissaoPct / 100).toFixed(2); // Calcula sobre Setup apenas
        const mesNome = c.Mes ? mesesCompletos[parseInt(c.Mes)] : '-';
        
        return [
            c.Nome, c.CNPJ, mesNome, mrr.toFixed(2), setup.toFixed(2), 
            total.toFixed(2), c.Pagamento, c.InfoPagamento || '-', 
            comissaoPct + '%', comissaoValor
        ].join(';');
    });
    
    const csv = [cabecalho.join(';'), ...linhas].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `vendas_monitor_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    showToast('CSV baixado com sucesso!');
}

// Sistema de Modal
let modalCallback = null;

function showModal(title, message, onConfirm) {
    const modal = document.getElementById('confirmModal');
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').textContent = message;
    modalCallback = onConfirm;
    modal.classList.add('show');
}

function closeModal() {
    const modal = document.getElementById('confirmModal');
    modal.classList.remove('show');
    modalCallback = null;
}

function confirmModal() {
    if (modalCallback) {
        modalCallback();
    }
    closeModal();
}

// Fechar modal ao clicar fora
window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>

<!-- Modal de Confirma√ß√£o -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3 id="modalTitle">Confirma√ß√£o</h3>
        </div>
        <div class="modal-body" id="modalBody">
            Deseja realmente executar esta a√ß√£o?
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-danger" id="modalConfirmBtn" onclick="confirmModal()">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>

</body>
</html>
