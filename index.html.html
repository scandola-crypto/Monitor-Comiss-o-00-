<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Vendas - Monitor Contábil</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: Arial, sans-serif; background-color: #003366; color: #fff; margin: 20px; }
    h1 { color: #ff6600; display: flex; align-items: center; gap: 10px; }
    h1 img { height: 40px; }
    .container { display: flex; flex-direction: column; gap: 20px; }
    table { width: 100%; border-collapse: collapse; background: #003366; color: #fff; }
    th, td { border: 1px solid #ff6600; padding: 8px; text-align: center; }
    th { background-color: #ff6600; color: white; }
    button { padding: 5px 10px; background-color: #ff6600; color: #003366; border: none; cursor: pointer; margin: 2px; }
    button:hover { background-color: #fff; color: #003366; }
    input, select { padding: 5px; margin: 5px; }
    .form-container { background: #003366; padding: 10px; border: 1px solid #ff6600; }
    .charts { display: flex; flex-wrap: wrap; gap: 20px; }
    .chart-container { background: #003366; color: #fff; padding: 10px; border-radius: 5px; flex: 1; min-width: 300px; }
</style>
</head>
<body>
<h1><img src="https://i.imgur.com/2X1vBxp.png" alt="Logo Monitor Contábil">Dashboard de Vendas - Monitor Contábil</h1>
<div class="container">

    <div class="form-container">
        <h2>Adicionar / Editar Cliente</h2>
        <input type="hidden" id="clienteIndex">
        <input type="text" id="clienteNome" placeholder="Nome do Cliente">
        <input type="text" id="clienteCNPJ" placeholder="CNPJ">
        <input type="number" id="clienteMRR" placeholder="MRR">
        <input type="number" id="clienteSetup" placeholder="Implantação">
        <input type="text" id="clienteInfoPagamento" placeholder="Informação do Pagamento">
        <select id="clientePagamento">
            <option value="PIX">PIX</option>
            <option value="CARTÃO">CARTÃO</option>
            <option value="BOLETO">BOLETO</option>
        </select>
        <button onclick="salvarCliente()">Salvar</button>
    </div>

    <table id="tabelaVendas">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>CNPJ</th>
                <th>MRR</th>
                <th>Implantação</th>
                <th>Pagamento</th>
                <th>Info Pagamento</th>
                <th>Comissão %</th>
                <th>Valor Comissão</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="charts">
        <div class="chart-container">
            <canvas id="graficoValores"></canvas>
        </div>
    </div>

    <div style="margin-top: 10px;">
        <button onclick="baixarCSV()">Baixar CSV</button>
    </div>
</div>

<script>
let clientes = [
    {Nome: 'ALAN FIALHO GANDRA FILHO', CNPJ: '639.628.883-49', MRR: 200, Setup: 1300, Pagamento: 'PIX', InfoPagamento: 'mes 10 1-out.'},
    {Nome: 'CONTABILIDADE CUPT', CNPJ: '28.686.485/0001-38', MRR: 674, Setup: 1000, Pagamento: 'CARTÃO', InfoPagamento: 'mes 10 2-out.'}
];

// Carregar dados salvos do localStorage
const clientesSalvos = localStorage.getItem('clientes');
if(clientesSalvos) {
    clientes = JSON.parse(clientesSalvos);
}

function calcularComissao(valorTotal) {
    if(valorTotal <= 20000) return 20;
    else if(valorTotal <= 25000) return 25;
    else if(valorTotal <= 30000) return 30;
    else return 40;
}

function atualizarTabela() {
    localStorage.setItem('clientes', JSON.stringify(clientes)); // salva os dados

    const tbody = document.querySelector('#tabelaVendas tbody');
    tbody.innerHTML = '';
    clientes.forEach((c, index) => {
        const valorTotal = parseFloat(c.MRR) + parseFloat(c.Setup);
        const comissaoPct = calcularComissao(valorTotal);
        const valorComissao = (valorTotal * comissaoPct / 100).toFixed(2);

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${c.Nome}</td>
            <td>${c.CNPJ}</td>
            <td>${c.MRR}</td>
            <td>${c.Setup}</td>
            <td>${c.Pagamento}</td>
            <td>${c.InfoPagamento}</td>
            <td>${comissaoPct}%</td>
            <td>R$ ${valorComissao}</td>
            <td>
                <button onclick="editarCliente(${index})">Editar</button>
                <button onclick="excluirCliente(${index})">Excluir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    atualizarGraficos();
}

function salvarCliente() {
    const index = document.getElementById('clienteIndex').value;
    const Nome = document.getElementById('clienteNome').value;
    const CNPJ = document.getElementById('clienteCNPJ').value;
    const MRR = document.getElementById('clienteMRR').value;
    const Setup = document.getElementById('clienteSetup').value;
    const Pagamento = document.getElementById('clientePagamento').value;
    const InfoPagamento = document.getElementById('clienteInfoPagamento').value;

    if(Nome && CNPJ && MRR && Setup && InfoPagamento) {
        if(index === '') {
            clientes.push({Nome, CNPJ, MRR, Setup, Pagamento, InfoPagamento});
        } else {
            clientes[index] = {Nome, CNPJ, MRR, Setup, Pagamento, InfoPagamento};
        }
        document.getElementById('clienteIndex').value = '';
        document.getElementById('clienteNome').value = '';
        document.getElementById('clienteCNPJ').value = '';
        document.getElementById('clienteMRR').value = '';
        document.getElementById('clienteSetup').value = '';
        document.getElementById('clienteInfoPagamento').value = '';
        atualizarTabela();
    } else {
        alert('Preencha todos os campos!');
    }
}

function editarCliente(index) {
    const c = clientes[index];
    document.getElementById('clienteIndex').value = index;
    document.getElementById('clienteNome').value = c.Nome;
    document.getElementById('clienteCNPJ').value = c.CNPJ;
    document.getElementById('clienteMRR').value = c.MRR;
    document.getElementById('clienteSetup').value = c.Setup;
    document.getElementById('clientePagamento').value = c.Pagamento;
    document.getElementById('clienteInfoPagamento').value = c.InfoPagamento;
}

function excluirCliente(index) {
    clientes.splice(index, 1);
    atualizarTabela();
}

let graficoValores;
function atualizarGraficos() {
    const totalMRR = clientes.reduce((acc, c) => acc + parseFloat(c.MRR), 0);
    const totalSetup = clientes.reduce((acc, c) => acc + parseFloat(c.Setup), 0);
    const totalComissao = clientes.reduce((acc, c) => {
        const valorTotal = parseFloat(c.MRR) + parseFloat(c.Setup);
        return acc + (valorTotal * calcularComissao(valorTotal) / 100);
    }, 0);

    const ctxValores = document.getElementById('graficoValores').getContext('2d');

    if(graficoValores) graficoValores.destroy();

    graficoValores = new Chart(ctxValores, {
        type: 'bar',
        data: {
            labels: ['Totais'],
            datasets: [
                { label: 'MRR Total', data: [totalMRR], backgroundColor: '#ff6600' },
                { label: 'Implantação Total', data: [totalSetup], backgroundColor: '#00ccff' },
                { label: 'Comissão Total', data: [totalComissao.toFixed(2)], backgroundColor: '#ffcc00' }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: '#fff' } } },
            scales: {
                x: { ticks: { color: '#fff' }, grid: { color: '#001f4d' } },
                y: { ticks: { color: '#fff' }, grid: { color: '#001f4d' } }
            }
        }
    });
}

function baixarCSV() {
    if(clientes.length === 0) {
        alert('Não há dados para baixar!');
        return;
    }

    const cabecalho = ['Nome','CNPJ','MRR','Implantação','Pagamento','Info Pagamento','Comissão %','Valor Comissão'];
    const linhas = clientes.map(c => {
        const valorTotal = parseFloat(c.MRR) + parseFloat(c.Setup);
        const comissaoPct = calcularComissao(valorTotal);
        const valorComissao = (valorTotal * comissaoPct / 100).toFixed(2);
        return [c.Nome, c.CNPJ, c.MRR, c.Setup, c.Pagamento, c.InfoPagamento, comissaoPct + '%', valorComissao].join(';');
    });

    const csvContent = [cabecalho.join(';'), ...linhas].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'vendas_monitor_contabil.csv');
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

atualizarTabela();
</script>
</body>
</html>
